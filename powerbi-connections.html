<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerBI Join Connections - Cube.js Semantic Layer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .query-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .query-title {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .query-description {
            color: #666;
            margin-bottom: 15px;
        }
        .query-url {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
            margin-bottom: 15px;
        }
        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .copy-btn:hover {
            background: #5a67d8;
        }
        .tables-info {
            background: #e8f5e8;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #2d5a2d;
            margin-bottom: 10px;
        }
        .section {
            margin-bottom: 40px;
        }
        .section-title {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”— PowerBI Join Connections</h1>
        <p>Pre-built URLs for PowerBI integration with automatic table joins</p>
        <p><strong>Cube.js Semantic Layer</strong> | PostgreSQL Backend</p>
    </div>

    <div class="section">
        <h2 class="section-title">ğŸ”¥ Most Popular Joined Queries</h2>
        
        <div class="query-card">
            <div class="query-title">ğŸ“Š Sales Revenue by Customer Segment</div>
            <div class="query-description">Revenue and order count by customer segment and region</div>
            <div class="tables-info">ğŸ“‹ Auto-Joins: Sales + Customers (via customer_id)</div>
            <div class="query-url" id="url1">http://localhost:4000/cubejs-api/v1/load?query={"measures":["Sales.totalRevenue","Sales.count","Customers.count","Customers.averageLifetimeValue"],"dimensions":["Customers.customerSegment","Sales.region"]}</div>
            <button class="copy-btn" onclick="copyToClipboard('url1')">ğŸ“‹ Copy URL</button>
            <button class="copy-btn" onclick="showMCode('salesWithCustomers')">ğŸ“ Get M Code</button>
        </div>

        <div class="query-card">
            <div class="query-title">ğŸš€ Sales Performance by Marketing Campaign</div>
            <div class="query-description">Revenue attribution to marketing campaigns with ROI analysis</div>
            <div class="tables-info">ğŸ“‹ Auto-Joins: Sales + Marketing (via campaign_id)</div>
            <div class="query-url" id="url2">http://localhost:4000/cubejs-api/v1/load?query={"measures":["Sales.totalRevenue","Sales.count","Marketing.totalBudget","Marketing.totalAdSpend"],"dimensions":["Marketing.campaignType","Marketing.campaignName","Sales.region"]}</div>
            <button class="copy-btn" onclick="copyToClipboard('url2')">ğŸ“‹ Copy URL</button>
            <button class="copy-btn" onclick="showMCode('salesWithMarketing')">ğŸ“ Get M Code</button>
        </div>

        <div class="query-card">
            <div class="query-title">ğŸ¯ Complete Business Intelligence (3 Tables)</div>
            <div class="query-description">Full business view: Sales + Marketing + Customer data in one query</div>
            <div class="tables-info">ğŸ“‹ Auto-Joins: Sales + Marketing + Customers (via customer_id + campaign_id)</div>
            <div class="query-url" id="url3">http://localhost:4000/cubejs-api/v1/load?query={"measures":["Sales.totalRevenue","Marketing.totalBudget","Customers.count","Marketing.activeCampaigns"],"dimensions":["Sales.region","Customers.customerSegment","Marketing.campaignType"]}</div>
            <button class="copy-btn" onclick="copyToClipboard('url3')">ğŸ“‹ Copy URL</button>
            <button class="copy-btn" onclick="showMCode('salesMarketingCustomers')">ğŸ“ Get M Code</button>
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">ğŸ“ˆ Advanced Analytics Joins</h2>
        
        <div class="query-card">
            <div class="query-title">ğŸ“Š Daily Sales Trends by Campaign</div>
            <div class="query-description">Daily sales trends with marketing campaign attribution</div>
            <div class="tables-info">ğŸ“‹ Auto-Joins: Sales + Marketing (via campaign_id) | Time Series</div>
            <div class="query-url" id="url4">http://localhost:4000/cubejs-api/v1/load?query={"measures":["Sales.totalRevenue","Marketing.totalAdSpend"],"dimensions":["Sales.orderDate","Marketing.campaignName"],"timeDimensions":[{"dimension":"Sales.orderDate","granularity":"day"}]}</div>
            <button class="copy-btn" onclick="copyToClipboard('url4')">ğŸ“‹ Copy URL</button>
            <button class="copy-btn" onclick="showMCode('dailySalesWithCampaigns')">ğŸ“ Get M Code</button>
        </div>

        <div class="query-card">
            <div class="query-title">ğŸ’° Customer LTV by Acquisition Source</div>
            <div class="query-description">Customer lifetime value analysis by acquisition channel</div>
            <div class="tables-info">ğŸ“‹ Auto-Joins: Sales + Customers (via customer_id)</div>
            <div class="query-url" id="url5">http://localhost:4000/cubejs-api/v1/load?query={"measures":["Customers.averageLifetimeValue","Customers.count","Sales.totalRevenue","Sales.averageOrderValue"],"dimensions":["Customers.acquisitionChannel","Customers.customerSegment"]}</div>
            <button class="copy-btn" onclick="copyToClipboard('url5')">ğŸ“‹ Copy URL</button>
            <button class="copy-btn" onclick="showMCode('customerValueAnalysis')">ğŸ“ Get M Code</button>
        </div>

        <div class="query-card">
            <div class="query-title">ğŸ¯ Marketing ROI by Customer Segment</div>
            <div class="query-description">Marketing return on investment analysis by customer segments</div>
            <div class="tables-info">ğŸ“‹ Auto-Joins: Sales + Marketing + Customers (via customer_id + campaign_id)</div>
            <div class="query-url" id="url6">http://localhost:4000/cubejs-api/v1/load?query={"measures":["Sales.totalRevenue","Marketing.totalBudget","Marketing.totalAdSpend","Customers.count"],"dimensions":["Customers.customerSegment","Marketing.campaignType","Marketing.platform"]}</div>
            <button class="copy-btn" onclick="copyToClipboard('url6')">ğŸ“‹ Copy URL</button>
            <button class="copy-btn" onclick="showMCode('marketingROIbySegment')">ğŸ“ Get M Code</button>
        </div>
    </div>

    <div class="instructions">
        <h3>ğŸ”§ PowerBI Setup Instructions</h3>
        <ol>
            <li><strong>Open PowerBI Desktop</strong></li>
            <li><strong>Get Data</strong> â†’ <strong>Web</strong></li>
            <li><strong>Paste URL</strong> from above (click Copy URL button)</li>
            <li><strong>Advanced</strong> â†’ <strong>HTTP Headers</strong>:
                <ul>
                    <li><strong>Name:</strong> Authorization</li>
                    <li><strong>Value:</strong> Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.Et9HFtf9R3GEMA0IICOfFMVXY7kkTX1wr4qCyhIf58U</li>
                </ul>
            </li>
            <li><strong>Navigate:</strong> data â†’ List (in PowerBI Navigator)</li>
            <li><strong>Transform Data</strong> if needed</li>
        </ol>
        <p><strong>âœ… All joins happen automatically!</strong> No need to manually join tables in PowerBI.</p>
    </div>

    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('URL copied to clipboard!');
            });
        }

        function showMCode(queryType) {
            const mCodes = {
                'salesWithCustomers': `let
    // Sales Revenue by Customer Segment - WORKING M CODE
    // Auto-joins: Sales + Customers via customer_id
    Source = Json.Document(
        Web.Contents(
            "http://localhost:4000/cubejs-api/v1/load",
            [
                Query = [
                    query = "{\\"measures\\":[\\"Sales.totalRevenue\\",\\"Sales.count\\",\\"Customers.count\\",\\"Customers.averageLifetimeValue\\"],\\"dimensions\\":[\\"Customers.customerSegment\\",\\"Sales.region\\"]}"
                ],
                Headers = [
                    Authorization = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.Et9HFtf9R3GEMA0IICOfFMVXY7kkTX1wr4qCyhIf58U"
                ]
            ]
        )
    ),
    ExtractData = Source[data],
    ConvertToTable = Table.FromRecords(ExtractData),
    ChangeTypes = Table.TransformColumnTypes(ConvertToTable,{
        {"Sales.totalRevenue", type number},
        {"Sales.count", Int64.Type},
        {"Customers.count", Int64.Type},
        {"Customers.averageLifetimeValue", type number}
    })
in
    ChangeTypes`,
                
                'salesWithMarketing': `let
    // Sales Performance by Marketing Campaign - WORKING M CODE
    // Auto-joins: Sales + Marketing via campaign_id
    Source = Json.Document(
        Web.Contents(
            "http://localhost:4000/cubejs-api/v1/load",
            [
                Query = [
                    query = "{\\"measures\\":[\\"Sales.totalRevenue\\",\\"Sales.count\\",\\"Marketing.totalBudget\\",\\"Marketing.totalAdSpend\\"],\\"dimensions\\":[\\"Marketing.campaignType\\",\\"Marketing.campaignName\\",\\"Sales.region\\"]}"
                ],
                Headers = [
                    Authorization = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.Et9HFtf9R3GEMA0IICOfFMVXY7kkTX1wr4qCyhIf58U"
                ]
            ]
        )
    ),
    ExtractData = Source[data],
    ConvertToTable = Table.FromRecords(ExtractData),
    ChangeTypes = Table.TransformColumnTypes(ConvertToTable,{
        {"Sales.totalRevenue", type number},
        {"Sales.count", Int64.Type},
        {"Marketing.totalBudget", type number},
        {"Marketing.totalAdSpend", type number}
    })
in
    ChangeTypes`,
    
                'salesMarketingCustomers': `let
    // Complete Business Intelligence (3 Tables) - WORKING M CODE
    // Auto-joins: Sales + Marketing + Customers
    Source = Json.Document(
        Web.Contents(
            "http://localhost:4000/cubejs-api/v1/load",
            [
                Query = [
                    query = "{\\"measures\\":[\\"Sales.totalRevenue\\",\\"Marketing.totalBudget\\",\\"Customers.count\\",\\"Marketing.activeCampaigns\\"],\\"dimensions\\":[\\"Sales.region\\",\\"Customers.customerSegment\\",\\"Marketing.campaignType\\"]}"
                ],
                Headers = [
                    Authorization = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.Et9HFtf9R3GEMA0IICOfFMVXY7kkTX1wr4qCyhIf58U"
                ]
            ]
        )
    ),
    ExtractData = Source[data],
    ConvertToTable = Table.FromRecords(ExtractData),
    ChangeTypes = Table.TransformColumnTypes(ConvertToTable,{
        {"Sales.totalRevenue", type number},
        {"Marketing.totalBudget", type number},
        {"Customers.count", Int64.Type},
        {"Marketing.activeCampaigns", Int64.Type}
    })
in
    ChangeTypes`
            };

            const code = mCodes[queryType] || 'M Code not available for this query';
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            newWindow.document.write(`
                <html>
                <head><title>PowerBI M Code - ${queryType}</title></head>
                <body style="font-family: Consolas, monospace; padding: 20px;">
                    <h3>PowerBI M Code</h3>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto;">${code}</pre>
                    <button onclick="navigator.clipboard.writeText(\`${code.replace(/`/g, '\\`')}\`)">Copy Code</button>
                </body>
                </html>
            `);
        }
    </script>
</body>
</html>